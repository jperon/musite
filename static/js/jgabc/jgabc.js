function encode_utf8(e){return utf8_bom+unescape(encodeURIComponent(e))}function decode_utf8(e){return decodeURIComponent(escape(e))}function Header(e){"string"!=typeof e&&(e=""),this.comments=[],this.cValues={},this.original="";var t=e.match(regexHeaderEnd);if(t){var n=this.original=e.slice(0,t.index+t[0].length),a=n.split(/\r?\n/g);for(i in a){var s=a[i],t=regexHeaderLine.exec(s);if(t)if(this[t[1]]){var r=t[1]+"Array";this[r]||(this[r]=[this[t[1]]]),this[r].push(t[2])}else this[t[1]]=t[2];else(t=regexHeaderComment.exec(s))&&"%%"!=s&&(t=regexHeaderLine.exec(s.slice(1)),t?this.cValues[t[1]]=t[2]:this.comments[i]=s)}}}function getHeaderLen(e){var t=e.match(regexHeaderEnd);return t?t.index+t[0].length:0}function getHeader(e){return new Header(e)}function updateLinks(e){var t=getHeader(e);t?e=e.slice(t.original.length):t="%%\n",linkSelector&&$(linkSelector).attr("href","http://gregorio.gabrielmass.com/cgi/process.pl?gregtext="+window.escape(t+e)+"&gregfontselect=17&gregtextfontselect=12&greginitialselect=43&gregspaceselect=7mm&gregredselect=N&greglinethickselect=10&gregpaperselect=letterpaper&gregfaceselect=libertine&gregcropselect=N");try{if(linkDownloadSelector){var n=encode_utf8(t+e),a="data:text/plain;charset=utf8;base64,"+btoa(n),i=t.name||"Untitled";i.match(/\.gabc$/)||(i+=".gabc"),$(linkDownloadSelector).attr("charset","UTF-8").attr("href",a).attr("data-downloadurl","text/plain:"+i+":"+a)}}catch(s){}return[t,e]}function updateChant(e,t,n){var a=t,i=$(t);if(i.is("svg")||(i=i.find("svg"),i.length||(i=$(_svg).clone().appendTo(t)),t=i[0]),t!=_svg&&otherElements.indexOf(t)<0&&a&&otherElements.push(a),!dontUpdateChant&&e){var s=updateLinks(e);if(_timeoutGabcUpdate&&clearTimeout(_timeoutGabcUpdate),!n){var r=gabcProcessTime+100;return _timeoutGabcUpdate=setTimeout(function(){updateChant(e,t,!0)},r),void 0}_nextUpdate=(new Date).getTime()+100+gabcProcessTime;var l=new Date;e=s,_timeoutGabcUpdate=null;var o=$(t).find(">g")[0];if(o){var c=[0],d=getChant(e,t,o,c),f=d.getBBox().height+c[0]+_heightCorrection-_defText.getExtentOfChar("q").height;$(t).height(f),t.parentNode.tagName.match(/span/i)&&$(t).css("width",d.getBBox().width),gabcProcessTime=new Date-l,console.info("Update chant time: "+gabcProcessTime),gabcProcessTime>3e3&&(gabcProcessTime=3e3)}}}function make(e,t,n){var i=document.createElementNS(svgns,e);if(t&&i.appendChild(document.createTextNode(t)),n)switch(typeof n){case"string":i.setAttribute("class",n);break;case"object":for(a in n)i.setAttribute(a,n[a])}return i}function textWidth(e,t,n){var a=0,i=void 0;if(0===e.length)return 0;if("number"==typeof t&&"number"==typeof n&&(a=t,i=n,t="goudy",n=void 0,0===i))return 0;var s=n?_defText:defText;if($.isArray(e)){var r,l;if(1!=e.length||0!=e[0].tags.length){if(0==a&&!i&&(l=JSON.stringify(e))&&(r=_txtWidths[l]))return r;$(s).empty();var o=0,c=0;return e.forEach(function(e){var t=e.span();s.appendChild(t);var n=Math.max(a,c),r=t.textContent.length,l=Math.min(c+r,a+(i||1e6))-n;n-=c,c+=r;try{l>0&&n>=0&&(o+=t.getSubStringLength(n,l))}catch(d){console.warn(d)}}),l&&(_txtWidths[l]=o||s.getComputedTextLength()),o}if(e=e[0].text,0==e.length)return 0;if(void 0==t&&(t=""),0==a&&!i&&(l=t+","+e)&&(r=_txtWidths[l]))return r}else if("object"==typeof e){if(1==e.childNodes.length){var d=e.firstChild,l=$(d).attr("class").replace(new RegExp("(?:^|\\s)"+fontclass+"(?:\\s|$)|\\s+$","g"),"")+","+d.textContent,r=_txtWidths[l];if(r)return r}$(s).empty().append($(e).clone());var o=s.getComputedTextLength();return l&&(_txtWidths[l]=o),o}t&&s.setAttribute("class",t),$(s).text(e.replace(/ /g," "));var o=s.getSubStringLength(a,i||e.length);return l&&(_txtWidths[l]=o),o}function useWidth(e,t,n){if(e.tagName.match(/^use$/i)&&(e=document.getElementById(e.getAttribute("href").slice(1))),"undefined"==typeof t)return getChantWidth(e.textContent);for(var a=0,i="",s="",r=[],l=0;l<e.childNodes.length;++l){var o=e.childNodes[l];if(a>=t){if(0==r.length&&getChantWidth(o.textContent)<=2?i=i.slice(0,0-s.length):s="",r.push(getChantWidth(i)),2==r.length)return r;i=s,t+=n}i+=o.textContent,s=o.textContent,a+=1}return r.push(getChantWidth(i)),r}function getChantWidth(e){return defChant.textContent=e,defChant.getComputedTextLength()}function selectGabc(e,t,n){var a=$("#"+$(n).parent().attr("for"));if(0==a.length&&(a=$("#editor")),e+=getHeaderLen(a.val()),a.is(":visible"))a=a[0];else{a=$("#hymngabc")[0];var i,s=0;for(i in _hymnGabcMap){if(i>e)break;s=_hymnGabcMap[i]+e-i}e=s}if(-1==t){var r=$(a).val().slice(e).match(/^[^) ]*/);t=r[0].length}a.select(e,t),a.selectionStart=e,a.selectionEnd=e+t}function getTagsFrom(e){for(var t,n=[];t=regexTag.exec(e);){n.push(t[2]);var a=t.index+t[0].length;e=0==t.index?e.slice(t[0].length):e.slice(0,t.index)+e.slice(a)}return n}function tagsForText(e,t){"string"==typeof e&&(e=[e]);var n=[],a=e[0];t||(t=[]);for(var i;i=regexTag.exec(a);){var s=a.slice(0,i.index);if(s.length>0&&n.push(new TagInfo(s,t)),"/"!=i[1])t.indexOf(i[2])<0&&t.push(i[2]);else{var r=t.indexOf(i[2]);r>=0&&t.splice(r,1)}var l=i.index+i[0].length;a=a.slice(l)}return e[0]=a,n}function TagInfo(e,t){if(this.tags=$.merge([],t||[]),this.text=e.replace(/ /g," "),t&&t.indexOf("v")>=0){this.span=this.spanV,this.spans=[];for(var e="",n=this.text.match(/\\[^\\\s]*|[^\\]+/g),a=0;a<n.length;++a){var i=n[a];if("\\"==i[0]){i=i.slice(1);var s=vCodes[i];if(s){this.spans.push({txt:s}),e+=s;continue}}this.spans.push(i),e+=i}this.text=e}}function relayoutChant(e){var t,n,a,i,s,r,l,o,c,d,f,u=svgWidth=$(e.parentNode).width(),h=$(e),g=h.children("g"),m=h.find("#commentary"),p=0,v=0,x=0,b=0,y=h.find("#system"+x),T=y[0],C=y[0].info,S=h.find("defs")[0],A=C.y,w=[],k=[],N=u-C.x-spaceBetweenNeumes;for(tagsBetweenText=[],C.ltone=3,C.htone=10,m.length&&m.attr("x",u-m[0].getComputedTextLength()),lastClefBeforeNeume=function(t){var n,a={clefTone:9};for(n in e.clefs){if(!(t>n))break;a=e.clefs[n]}return a},lastClefBeforePunctum=function(t){var n,a={clefTone:9};for(n in e.clefs)try{var i=parseInt($(e).find("#neume"+n).children()[0].id.match(/\d+$/)[0]);if(!(t>i))break;a=e.clefs[n].info}catch(s){}return a};;){r=s,l=n,t=g.find("#neume"+b),n=g.find("#neumetext"+b),a=g.find("#neumetrans"+b),s=t[0]?t[0].neume:n[0]?n[0].neume:{match:{}},delete s.custos;var _=g.find("#neumemask"+b);i=$.merge($.merge($.merge($.merge($(),t),n),a),_),d=i.toArray(),f=t.toArray().concat(_.toArray());var L=!1;for(U in s.ledgers){L=!0;break}if(c=s.offset||0,0==i.length)break;v+=Math.min(0,c),s.wChant>0&&(v>p||!n.length)?p=v:r.lastOnLineHyphen&&($(r.lastOnLineHyphen).remove(),delete r.lastOnLineHyphen);var I=n.length?p+s.wText+Math.max(Math.floor(c),0):I||0;s.match[7]&&s.match.index>0&&(I+=5);var O=p+s.wChant+(s.spaceBeforeNextNeume||spaceBetweenNeumes)-Math.min(c,0);if(s.x=p,Math.max(I,O)>N){var P=lastClefBeforeNeume(b),E=P?P.wChant:0;!l.length||r.lastOnLineHyphen||l.text().slice(-1).match(/-|\s/)||(r.lastOnLineHyphen=new TagInfo("-").span(),l.append(r.lastOnLineHyphen)),I-=p,O-=p,p=0,v=E+(s.spaceBeforeNextNeume||spaceBetweenNeumes)+c,s.wChant>0&&v>p&&(p=v),I+=p,O+=p,s.x=p,++x,w.length&&(k.push(w),w=[]),T.words=k,k=[],tagsBetweenText=[],o=T,trimStaff(T,u-C.x);var M=finishStaff(T);if(y=h.find("#system"+x),y.length)T=y[0],T.info.htone=10,T.info.ltone=3;else{var G=staffoffset+M+verticalSpace+C.y;T=addStaff(e,T.parentNode,0,G,x,null,S),T.info.vOffset=T.info.y,y=$(T)}C=T.info,N=u-C.x-(s.spaceBeforeNextNeume||spaceBetweenNeumes)}if(w=w.concat(i.toArray()),t.length&&(C.ltone=Math.min(C.ltone,s.info.ltone),C.htone=Math.max(C.htone,s.info.htone),y.append(t),o&&!s.gabc.match(/^[,;:]+$/)&&(addCustos(o,s),o=null)),a.length&&(a[0].neume=s),n.length){$(C.eText).append(n),$(C.eTrans).append(a);var B=tagsBetweenText.length-1;if(0>=B)tagsBetweenText[0]=f;else{var D=tagsBetweenText[0][0],F=D.neume.x+D.neume.wChant;F+=s.transformX||0;var W=p;0>c&&(W-=c);for(var H=0,U=1;B>=U;++U)H+=tagsBetweenText[U][0].neume.wChant;var R=W-F-H;R/=B+1;for(var q=F+R,U=1;B>=U;++U){for(j in tagsBetweenText[U])tagsBetweenText[U][j].neume.x=q;q+=R+tagsBetweenText[U][0].neume.wChant}tagsBetweenText=[f]}}else tagsBetweenText.length>0&&!s.info.ftone&&(tagsBetweenText.push(f),(1==w.length&&w[0]==t[0]||2==w.length&&w[0]==t[0]&&w[1]==_[0])&&(k.push(w),w=[]));L&&processLedger(s,t[0],w),s.match[7]&&(k.push(w),w=[]),p=I,v=O,++b}for(w.length&&k.push(w),T.words=k,justifyLine(T,!0,!0),T.custos&&($(T.custos).remove(),T.custos=void 0),T.custosLedger&&($(T.custosLedger).remove(),T.custosLedger=void 0),trimStaff(T,u-C.x),finishStaff(T),trimStaff(T);y.length;)++x,y=h.find("#system"+x),y.remove();var z=$(e).children("g")[0].getBBox().height+A+_heightCorrection-_defText.getExtentOfChar("q").height;e.setAttribute("height",z),$(e).height(z)}function getChant(e,t,n,a){a||(a=[]);var i=e[0];e=e[1];var s=e.match(/[\r\n]\s*[-\w]+:[^;]+;\s*[\r\n]/);s&&(e=e.slice(0,s.index));var r=t.parentNode.getAttribute("for"),l=$("#"+r);l.is("textarea")||(r=l=null);var o=t?t.parentNode&&("chant-preview"==t.parentNode.id||r):!1,c=$(t).find("defs")[0];c||(c=_defs);var d,f=0,u=0;n?$(n).empty():(n=make("g"),n.setAttribute("transform","translate(0,"+staffoffset+")"),n.setAttribute("class","caeciliae")),o&&(t.clefs=[],t.accidentals=[],t.tones=[],syllableOffsetCorrection={});var h=$(t.parentNode).width(),g=i["user-notes"],m=i.commentary,p=String(i.cValues.timing||"").split(" ")||[],v=String(i.cValues.volume||"").split(" ")||[],x=0;if("string"==typeof g&&g.length>0){var b=make("text",g);b.setAttribute("id","userNotes"),b.setAttribute("class",fontclass+" i"),b.setAttribute("y",16-staffoffset),n.appendChild(b),x=20}if("string"==typeof m&&m.length>0){var b=make("text",m);b.setAttribute("id","commentary"),b.setAttribute("class",fontclass+" i"),b.setAttribute("y",16-staffoffset),n.appendChild(b),b.setAttribute("x",h-b.getComputedTextLength()),x=20}a[0]=x,regexOuter.lastIndex=0;var y,T,C,S,A,w,k,N,_,L,I=0,O=0,P=null,E=0,M=!0,G=0,B=[],D=[],F=[],W=!1,H=fontclass,U=[],j=addStaff(t,n,0,x,G,null,c),R=j.info;try{var q=$(t.parentNode).css("padding-left");q&&(h-=parseFloat(q))}catch(z){}for(svgWidth=h;gmatch=regexOuter.exec(e);)for(var K,V=gmatch[5]?gmatch[5].match(/(?:\[[^\]]*\]?|[^[\/,;:]+\/*|\/+)+|[`,;:]+/g):[""],Z=gmatch.index,X=0;X<V.length;++X){var d=1==V.length?gmatch:0==X?gmatch.slice(0,6):X==V.length-1?gmatch.slice(4):["",""];5==d.length&&d.splice(0,0,"","","",""),d.index=Z+=d[1].length;var Y=V[X];Z+=Y.length;var J=Y.match(/\/+$/);if(J?(J=J[0].length,Y=Y.slice(0,-J),K=J*slashSpace):K=spaceBetweenNeumes,"z0"!=Y){var Q={index:d.index,match:d,ledgers:{},wChant:0,wText:0,spaceBeforeNextNeume:K},et=[];Q.gabc=Y,Q.info=getChantFragment(Q.gabc||"/",c),k=Q.info.clef||k,o&&(Q.info.clef&&(t.clefs[f]=_=Q,_.clefs=[],t.accidentals[u]=3==k.length?-1:null),t.tones=t.tones.concat(Q.info.tones));for(var tt=Q.info.def.textContent,nt=0;nt<Q.info.tones.length;++nt){var at=Q.info.tones[nt];at.choralSign&&(tt=tt.replace(at.choralSign,""))}defChant.textContent=tt,Q.wChant=defChant.getComputedTextLength(),Q.gabc==k&&(N=Q.wChant),D.length>0&&L&&(L[7]||L[8])&&(B.push(D),D=[]);var it=d[7]||d[8],b=d[3]||it,st=regexSqBrackets.exec(b);st&&(b=b.slice(0,st.index)+b.slice(st.index+st[0].length),st=st[1]);var rt=b;d[3]&&it&&(b+=it),Q.txt=b,Q.translation=st;var lt=0;if(b){if(M&&d[3]&&(M=!1,"0"!=i["initial-style"])){var ot=b[0];b=b.slice(1),0==b.replace(/[{}]/g,"").length&&(b="-");var ct=R.txtInitial=make("text",ot);ct.setAttribute("transform","translate(0,"+R.vOffset+")"),o&&f==selectedNeume?ct.setAttribute("class","greinitial selectable selected neume"+f):ct.setAttribute("class","greinitial selectable neume"+f),n.appendChild(ct);var dt=ct.getComputedTextLength(),ft=i.annotation;if("string"==typeof ft&&ft.length>0){var s=/([a-g]\d?\*?\s*)$/.exec(ft),ut="</sc>";s&&(ft=ft.slice(0,s.index),ut+=s[0]),ft=ft.replace(/\b[A-Z\d]+\b/,function(e){return e.toLowerCase()})+ut;var ht=R.txtAnnotation=make("text"),gt=tagsForText("<sc><v>"+ft+"</v></sc>");for(nt in gt)ht.appendChild(gt[nt].span());ht.setAttribute("class","greannotation"),ht.setAttribute("y",R.vOffset-25),n.appendChild(ht);var mt=ht.getComputedTextLength(),pt=Math.max(mt,dt)/2;ht.setAttribute("x",pt-mt/2),ct.setAttribute("x",pt-dt/2),E=Math.max(mt,dt)+5}else E=dt+5;R.eText.setAttribute("transform","translate("+E+","+R.vOffset+")"),R.eTrans.setAttribute("transform","translate("+E+","+R.vOffset+")"),R.x=E;var vt=$(j).find("use[href=#staff]")[0];vt.setAttribute("transform","scale("+(h-E)+",1)")}b=b.replace(/^\s+/,"").replace(/\r\n/g," ").replace(/\n/g," ").replace(/<v>(?:\\greheightstar|\$\\star\$)<\/v>/g,"*").replaceSpTags();var xt=[b];et=tagsForText(xt,F),b=xt[0];var bt="";if(et.length>0&&et.forEach(function(e){bt+=e.text}),b.length>0){var yt=b.replace(/[{}]/g,"");yt.length>0&&et.push(new TagInfo(yt,F))}if(b=bt+b,Q.wText=textWidth(et),b){var Tt,Ct=b.indexOf("{"),St=b.indexOf("}");if(Ct>=0&&St>Ct){var At=b.slice(Ct+1,St);b=b.slice(0,Ct)+At+b.slice(St+1),--St,Tt={index:Ct,0:At,1:At}}else Tt=/^english$/i.exec(i["centering-scheme"])?{index:0,0:b.replace(/[,.:;\s]*$/,""),1:b.replace(/[,.:;\s]*$/,"")}:regexVowel.exec(b);Tt||(Tt={index:0,0:b.trimRight(),1:b.trimRight()});try{var wt=Tt.index+Tt[0].length-Tt[1].length;lt-=textWidth(et,0,wt),lt-=textWidth(et,wt,Tt[1].length)/2}catch(z){}lt+=notewidth/2}}var $t=Q.info.startsWithAccidental?getChantWidth("b-"):0;lt+=$t,Q.offset=lt,O+=Math.min(0,lt),Q.wChant>0&&(O>I||!b)&&(I=O);var kt=b?I+Q.wText+Math.max(Math.floor(lt),0):kt||0;d[7]&&d.index>0&&(kt+=5);var Nt=Math.max(I,O)+Q.wChant+K-Math.min(lt,0),_t=0==Q.wText?Math.max(_t||0,I):Math.max(kt,Nt);if(S||_t>=h-E-K-Q.wChant){W=j,W.justify=S?S.justify:!0,W.justify||(A=I),S=void 0,U=[],P&&b&&"-"!=$(P).text().slice(-1)&&P.appendChild(Q.lastOnLineHyphen=new TagInfo("-").span()),D.length>0&&(B.push(D),D=[]),j.words=B,B=[];var Lt=finishStaff(j),It=staffoffset+Lt+verticalSpace+R.y;if(j=addStaff(t,n,0,It,++G,null,c),j.info.vOffset=j.info.y,R=j.info,R.eText.setAttribute("transform","translate(0,"+R.vOffset+")"),R.eTrans.setAttribute("transform","translate(0,"+R.vOffset+")"),_t-=I,kt-=I,Nt-=I,k){var y=make("use");y.setAttribute("class","clef"),y.setAttributeNS(xlinkns,"href","#"+k),y.setAttribute("x",0),y.setAttribute("y",0),j.appendChild(y),_&&_.clefs&&_.clefs.push(y),I=0,O=N+K+lt,Q.wChant>0&&O>I&&(I=O),_t+=I,kt+=I,Nt+=I}else I=0}if(S=Q.gabc&&Q.gabc.match(/z(?!0)/i),S&&(S.justify=Q.gabc.match(/z/)),Q.gabc||""===Q.gabc){if(W&&!Q.gabc.match(/^[`,;:]+$/)&&(addCustos(W,Q,W.justify,A),W=!1,E=0),Q.info.mask?(T=make("use"),T.setAttributeNS(xlinkns,"href","#"+Q.info.mask),T.setAttribute("id","neumemask"+f),T.setAttribute("class","caeciliae"),T.setAttribute("x",I),T.setAttribute("y",0),D.push(T),masks[G].firstChild.appendChild(T)):T=null,R.ltone=Math.min(R.ltone,Q.info.ltone),R.htone=Math.max(R.htone,Q.info.htone),o?y=$(Q.info.def).clone()[0]:(y=make("use"),y.setAttributeNS(xlinkns,"href","#"+Q.gabc)),y.setAttribute("id","neume"+f),y.setAttribute("x",I),y.setAttribute("y",0),y.neume=Q,o){if(f==selectedNeume){selectedNeumeTag=y;var Ot=$(y).children().last();syllableGabcOriginalLength=""==Q.gabc?0:parseInt(Ot.attr("offset"))+parseInt(Ot.attr("len"))}if(u=setUpPunctaIn(y,u,t),it){var At=k&&3==k.length?-1:null;t.accidentals[t.accidentals.length-1]!=At&&(t.accidentals[u]=At)}}if(j.appendChild(y),D.push(y),currentUse=[y],T&&currentUse.push(T),b){var Pt=U.length-1;if(0>=Pt)U[0]=currentUse;else{var Et=U[0][0],Mt=parseFloat(Et.getAttribute("x"))+Et.neume.wChant,Gt=Et.getAttribute("transform");if(Gt){var s=regexTranslate.exec(Gt);Mt+=parseFloat(s[1])}var Bt=I;0>lt&&(Bt-=lt);for(var Dt=0,nt=1;Pt>=nt;++nt)Dt+=U[nt][0].neume.wChant;var Ft=Bt-Mt-Dt;Ft/=Pt+1;for(var Wt=Mt+Ft,nt=1;Pt>=nt;++nt)$(U[nt]).attr("x",Wt),Wt+=Ft+U[nt][0].neume.wChant;U=[currentUse]}}else U.length>0&&!Q.info.ftone?(U.push(currentUse),(1==D.length&&D[0]==y||2==D.length&&D[0]==T&&D[1]==y)&&(B.push(D),D=[])):Q.info.ftone&&(U=[])}else y=T=null;if(b){w=P,pneume=C,P=make("tspan"),C=Q;var Ht=I;if(y&&(Q.transform="translate("+-lt+")",Q.transformX=-lt,lt>0?Ht-lt>=O?(Q.wText-=lt,y.setAttribute("transform",Q.transform),T&&T.setAttribute("transform",Q.transform)):(Ht+=lt,Q.wText+=lt):(y.setAttribute("transform",Q.transform),T&&T.setAttribute("transform",Q.transform))),w){var Ut=parseFloat(w.getAttribute("x"),10),jt=Ut+textWidth(w);if(Ht>jt&&"-"!=$(w).text().slice(-1)&&(w.appendChild(new TagInfo("-").span()),pneume.wText=textWidth(w),jt=Ut+pneume.wText,jt>Ht)){var Rt=jt-Ht;Ht=jt,y&&(y.setAttribute("x",I+Rt),T&&T.setAttribute("x",I+Rt)),kt+=Rt,Nt+=Rt}}P.setAttribute("id","neumetext"+f),P.setAttribute("x",Ht);var qt=rt.length;if(P.setAttribute("selectIndex",Q.index-1-qt),P.setAttribute("selectLen",qt),o&&f==selectedNeume?(syllableTextOriginalLength=qt,P.setAttribute("class",H+" selectable selected"),selectedNeumeTextTag=$(P)):P.setAttribute("class",H+" selectable"),P.neume=Q,I=kt,O=Nt,et.forEach(function(e){P.appendChild(e.span())}),st){var zt=new TagInfo(st,["i","trans"]).span();zt.setAttribute("id","neumetrans"+f),zt.setAttribute("x",Ht),D.push(zt),R.eTrans.appendChild(zt)}D.push(P),R.eText.appendChild(P)}else y?(O=Math.max(O,I+getChantWidth(Q.info.def.textContent)+K),I=kt):O=Math.max(O,I);f++,L=d,it&&(P=null),processLedger(Q,y,D)}}if(finishStaff(j),gabcSettings.trimStaff&&trimStaff(j),o){selectedNeumeTag&&$("#txtSyllableGabc,#txtSyllable").trigger("autoSizeInput");for(var Kt=[],Vt=[],Zt=100,Xt=0,Yt=0;Xt+Yt<t.tones.length;Xt++){for(;!(t.tones[Xt+Yt].isPlayable()||(++Yt,Xt+Yt>=t.tones.length)););if(Xt+Yt>=t.tones.length)break;var Jt=v[Xt],Qt=p[Xt]?/(\d+(?:\.\d+)?)(?:\:(\d+(?:\.\d+)?))?/.exec(p[Xt]):null;if(Zt=Jt&&parseInt(Jt)||Zt,Kt[Xt+Yt]=Zt,Qt&&Qt.length){var qt=parseFloat(Qt[1]);qt>20&&(qt/=400),Vt[Xt+Yt]={length:qt},Qt[2]&&(Vt[Xt+Yt].restAfter=parseFloat(Qt[2]))}}t.volumes=Kt,t.timings=Vt}return n}function processLedger(e,t,n){for(i in e.ledgers)$(e.ledgers[i]).remove();if(e.ledgers={},e.info.ledgerA&&(e.info.ledgerA.length||e.info.ledgerB.length)&&t){var a=t.parentNode,s=[];processLedgerHelper(e.info.ledgerA,s,!0),processLedgerHelper(e.info.ledgerB,s,!1),s.forEach(function(i){var s=insertLedger(i,a,t);e.ledgers[i.above]=s,n&&n.push(s)})}}function processLedgerHelper(e,t,n){var i=null,s=0;for(a in e){var r=e[a];r-1==i?++s:r-2==i?s+=2:(s>0&&t.push({i:i,len:s,above:n}),i=r,s=1)}s>0&&t.push({i:i,len:s,above:n})}function insertLedger(e,t,n,a){var i=0,s=1;"object"==typeof e&&(i=e.i,s=e.len,e=e.above);var r=make("use");r.setAttributeNS(xlinkns,"href",e?"#ledgera":"#ledgerb"),r.setAttribute("y",n.getAttribute("y"));var l=n.getAttribute("transform"),o=parseFloat(n.getAttribute("x"));if(l)for(;m=regexTranslateG.exec(l);)o+=parseFloat(m[1]);var c=useWidth(n,i,s);return o+=c[0],c=c[1],a?(o-=.25*notewidth,r.setAttribute("transform","translate("+o+") scale("+(c+.25*notewidth)+",1)")):(o-=.75*notewidth,r.setAttribute("transform","translate("+o+") scale("+(c+1.5*notewidth)+",1)")),n?t.insertBefore(r,n):t.appendChild(r),r}function addStaff(e,t,n,a,i,s,r){var l,o="staffmask"+i,c="staff"+i,d="system"+i;if(masks[i]){for(var f=masks[i].firstChild;f.childElementCount>1;)f.removeChild(f.childNodes[1]);l=f.firstChild}else{var u,h,g=masks[i];g&&g.parentNode!=r&&(g=$(r).find("#"+o)[0]),g?(u=g,h=u.firstChild,l=$(h).find(">rect")[0]):(u=make("mask"),u.setAttribute("maskUnits","objectBoundingBox"),u.setAttribute("id",o),h=make("g"),h.setAttribute("class","caeciliae"),u.appendChild(h),l=make("rect"),h.appendChild(l),r.appendChild(u)),masks[i]=u,u.setAttribute("transform","translate(0,"+a+")")}l.setAttribute("y",-staffheight),l.setAttribute("width","10000"),l.setAttribute("height",1+staffheight),l.setAttribute("fill","white");var m=make("g"),p=m.info={ltone:3,htone:10,vOffset:0,x:0,y:parseInt(a),eText:make("text"),eTrans:make("text")};p.eText.setAttribute("class",fontclass),p.eTrans.setAttribute("class",fontclass);var v=make("g");m.setAttribute("id",d),v.setAttribute("id",c),v.setAttribute("mask","url(#"+o+")");var x=make("use");return x.setAttributeNS(xlinkns,"href","#staff"),s||(s=$(e.parentNode).width()),x.setAttribute("transform","translate("+n+") scale("+s+",1)"),v.appendChild(x),m.appendChild(v),t.appendChild(m),m}function setGradient(e,t){var n=0==t?"RedBlack":"BlackRed",a=e.parentNode,i=$(e).index(),s=useWidth(a,i,1),r=a.neume.wChant||useWidth(a),l="grad"+n+s.join("_")+"_"+r;if(!(l in gradients)){var o=$(gradients[n]).clone(),c=o.find("stop");o.attr("id",l),$(c[0]).attr("offset",(s[0]+.25*s[1])/r),$(c[1]).attr("offset",(s[0]+.75*s[1])/r),_defs.appendChild(o[0]),gradients[l]=o[0]}e.setAttribute("style","fill:url(#"+l+")")}function setUpPunctaIn(e,t,n){var a=0,i=t,s=e.neume.info.tones,r=n.clefs;return $(e).children().each(function(){var e=s[a];e.match[rtg.accidental]?n.accidentals[t]=e.match[rtg.flat]?e.index-r[r.length-1].info.clefTone:null:e.match[rtg.whitespace]&&e.match[rtg.whitespace].match(/[,;:]/)&&(n.accidentals[t]=r.length&&3==r[r.length-1].gabc.length?-1:null),this.setAttribute("id","punctum"+t),this.tone=e;var l=parseInt(this.getAttribute("count"))||1;2==l?t==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected-1"),setGradient(this,0)):t+1==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected-2"),setGradient(this,1)):this.setAttribute("class","selectable"):t==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected")):this.setAttribute("class","selectable"),a+=parseInt(this.getAttribute("count"))||1,t=i+a}),t}function gabcEditorKeyDown(e){var t=$(this),n=t.val(),a=this.selectionStart,i=this.selectionEnd;switch(e.which){case 66:(e.ctrlKey||e.altKey)&&(e.preventDefault(),s=n.indexOf(" ",this.selectionEnd),0>=s&&(s=n.length),t.val(n.slice(0,s)+" ()"+n.slice(s)),this.selectionEnd=this.selectionStart=s+2);break;case 83:a==i&&(e.ctrlKey||e.altKey)&&"("!=n[a-1]&&")"!=n[a]&&(e.preventDefault(),t.val(n.slice(0,a)+"()"+n.slice(a)),this.selectionEnd=this.selectionStart=a+1);break;case 9:var s,r,l;if(e.preventDefault(),e.shiftKey)s=this.selectionStart,l=n.lastIndexOf("\n%%\n",s-1),s=n.lastIndexOf(")",s-1),l>=s&&(s=n.lastIndexOf(")")),s>=0&&(r=s,s=n.lastIndexOf("(",s));else{s=this.selectionEnd;var o=/(\()|(-(?!\())|(\s+(?![:;!.]))|([^)\s]$)/g;o.lastIndex=s;for(var c;(c=o.exec(n))&&(c[2]||c[3]);)if(!c[3]||0!=c.index&&")"!=n[c.index-1]){s=c.index;var d=n.lastIndexOf("\n",s-1)+1,f=n.indexOf("\n",s);0>f&&(f=n.length),"\r"==n[f]&&f--;var u=n.slice(d,f);if(!u.match(/^(?:\s*(?:%.*|[-\w]+:[^;]+;)\s*|%%)$/))break}c?c[1]?s=c.index:c[2]||c[3]||c[4]?((c[2]||c[4])&&(s=c.index+1),n=n.slice(0,s)+"()"+n.slice(s),t.val(n)):s=n.indexOf("("):s=n.indexOf("("),s=n.indexOf("(",s),s>=0&&(r=n.indexOf(")",s))}s>=0&&r>=0&&(this.selectionStart=s+1,this.selectionEnd=r);break;case 57:if(e.shiftKey){var h=this.value.slice(i),g=h.indexOf(")"),m=h.indexOf("(");if(0>g||m>=0&&g>m)return this.value=this.value.slice(0,this.selectionStart)+"()"+this.value.slice(i),this.selectionStart=this.selectionEnd=a+1,e.preventDefault(),void 0}break;case 48:e.shiftKey&&a==i&&")"==n[a]&&(e.preventDefault(),this.selectionStart=this.selectionEnd=a+1);break;case 8:var i=this.selectionEnd;i==this.selectionStart&&i>0&&")"==this.value[i]&&"("==this.value[i-1]&&(e.preventDefault(),this.value=this.value.slice(0,this.selectionStart-1)+this.value.slice(i+1),this.selectionStart=this.selectionEnd=i-1)}}String.prototype.repeat=function(e){return new Array(e+1).join(this)},String.prototype.trimRight||(String.prototype.trimRight=function(){return this.replace(/\s+$/,"")});var gabcSettings={trimStaff:!0,showSyllableEditorOnHover:!0},uuid,_indicesChar={flat:[57585,58176,57586,58177,57587,58178,57588,58179,57589,58180,57590,58181,57591],natural:[57593,58182,57594,58183,57595,58184,57596,58185,57597,58186,57598,58187,57599],flat_line:58176,natural_line:58182,punctum:57603,diamond:57619,virga:57635,v:57635,leftVirga:57651,quilisma:57667,w:57667,bottomPartPodatus:57684,topPartPodatus:57699,podatus:[null,57715,57731,57748,57763],o:57779,O:57795,diamond_tilde:57811,">":57827,"<":57843,upper_tilde:57859,lower_tilde:57875,porrectus:[null,57891,57907,57923,57939],r:57971,s:57987,custos:58019,"+":58019,dot:58035,apos:58050,ictus:58050,ictus_above:58053,ictus_below:58050,underscore:58066,episema:58066,episema_below:58066,episema_above:58069,underscore_longer:58082,episema_longer:58082,clivis:[null,58115,58131,58147,58163],accent_above_staff:58188,connecting_line:[void 0,void 0,59139,59155,59171,59187],decorative_line:[void 0,59203,59219,59235,59251,59267]},vCodes={Abar:"a",Vbar:"v",Rbar:"r"},_indicesLig={flat:"b",natural:"a",punctum:"p",diamond:"n",virga:"v",v:"v",leftVirga:"c",quilisma:"q",w:"q",podatus:"P",bottomPartPodatus:57684,topPartPodatus:"P",o:"o",O:"O",diamond_tilde:"N",">":"L","<":"k",upper_tilde:"K",lower_tilde:"l",porrectus:"R",r:"w",s:"s",custos:"u","+":"u",dot:".",apos:"I",ictus:"I",ictus_above:"I",ictus_below:"i",underscore:"H",episema:"H",episema_above:"H",episema_below:"h",underscore_longer:58082,episema_longer:58082,clivis:"C",accent_above_staff:"~",connecting_line:"x",decorative_line:"X"},fontclass="goudy",_neumeLig=function(e,t){if(arguments.length<2)return"";if("string"!=typeof e)return 2==arguments.length&&"number"==typeof e?_neumeChar(e,t):"";for(var n="",a=1;a<arguments.length;)n+=_ci[arguments[a++]];return n+e},_neumeChar=function(e,t){if(arguments.length<2)return"";var e,t,n=e;return e=parseInt(t),t=0,"object"==typeof n&&(arguments.length>2&&(t=parseInt(arguments[2])),n=n[Math.abs(t-e)],2==arguments.length&&(e=0)),String.fromCharCode(n+e)},_clefSpanLig=function(e){var t=parseInt(e.clef.slice(-1),10),n=2*t-1,a="";return 3==e.clef.length&&(a+=neume(indices.flat,n+1)+"-"),make("tspan",String(n)+(2==e.index?"d":"f")+"-"+a)},_clefSpanChar=function(e,t){var n,a,i=parseInt(e.clef.slice(-1),10),s=0;return 2==e.index?(a="d-",s=2-i):(a="f-",s=3-i),3==e.clef.length&&(a+=neume(indices.flat,4)+"-"),s*=spaceheight,t[0]=Math.min(t[0],s),n=make("tspan",a),n.setAttribute("dy",s),n},_ci=["B","A","0","1","2","3","4","5","6","7","8","9","Z"],staffheight=48,spaceheight=staffheight/4,notewidth=staffheight/6,spaceBetweenNeumes=notewidth,slashSpace=staffheight/20,verticalSpace=staffheight/4,fontsize=3*spaceheight/2,spaceWidth=3*spaceheight/4,staffoffset=Math.ceil(staffheight-spaceheight/2),svgns="http://www.w3.org/2000/svg",xlinkns="http://www.w3.org/1999/xlink",staffInFont=!1,fontExt="ttf",fontExtS="svg#webfont",fontFormat="truetype",fontFormatS="svg",filenameCaeciliae="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExt,filenameCaeciliaeS="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExtS,filenameCaeciliaePrint="Caeciliae-"+(staffInFont?"Regular":"Staffless")+"-Print."+fontExt,localCaeciliae="Caeciliae"+(staffInFont?"":" Staffless"),familyCaeciliae="Caeciliae"+(staffInFont?"":" Staffless"),styleCaeciliae="font-family: '"+familyCaeciliae+"'; font-size:"+staffheight+"px;",styleCaeciliaeSvg="font-family: '"+familyCaeciliae+" SVG'; font-size:"+staffheight+"px;",styleGoudy="font-family: 'OFL Sorts Mill Goudy TT'; font-size: "+fontsize+"px;",styleFont="@font-face {font-family: '"+familyCaeciliae+"'; font-weight: normal; font-style: normal;src: local('"+localCaeciliae+"'); src: url('"+filenameCaeciliae+"') format('"+fontFormat+"')}"+"@font-face {font-family: '"+familyCaeciliae+" SVG'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaeS+"') format('"+fontFormatS+"')}"+"@font-face {font-family: '"+familyCaeciliae+" Print'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaePrint+"') format('"+fontFormat+"')}"+"@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: italic; font-weight: normal; src: local('OFL Sorts Mill Goudy Italic TT'), local('OFLGoudyStMTT-Italic'), url('OFLGoudyStMTT-Italic.ttf') format('truetype');}"+"@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: normal; font-weight: normal; src: local('OFL Sorts Mill Goudy TT'), local('OFLGoudyStMTT'), url('OFLGoudyStMTT.ttf') format('truetype');}",svgWidth,_svg,svg,textElem,codea="a".charCodeAt(0),codem=codea+12,codeA="A".charCodeAt(0),codeM=codeA+12,regexTranslate=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/,regexTranslateG=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/g,regexHeaderEnd=/(?:^|\n)%%\s?\n/,regexOuter=/((([^\(\r\n]+)($|\())|\()([^\)]*)($|\))(?:(\s+)|(?=(?:\([^\)]*\))+(\s*))|)/g,regexTag=/<(\/)?(b|i|sc|v)>/i,regexSqBrackets=/\[([^\]]*)(?:\]|$)/,regexTags=/(<(b|i|sc)>)(.*?)(?:(<\/\1>)|$)/i,regexTagsSp=/<sp>([^<]*)<\/sp>/gi,spSubstitutions={"'ae":"ǽ","'æ":"ǽ",ae:"æ",oe:"œ","'œ":"œ","'oe":"œ",AE:"Æ",OE:"Œ",Ae:"Æ",Oe:"Œ","V/":"V","R/":"R","A/":"A"};String.prototype.replaceSpTags=function(){return this.replace(regexTagsSp,function(e){var t=e.slice(4,-5);return spSubstitutions[t]||t})};var regexInner=/[!\/ ,;:`]+|(([^\)!\/ ,;:`\[]+)(\[[^\]]*(?:$|\]))?)+/g,rog={syl:3,gabc:5,whitespace:7},linkSelector="",linkDownloadSelector="",setPdfLinkSelector=function(e){linkSelector=e},onDragStart=function(e){console.info(e),e.originalEvent.dataTransfer.setData("DownloadURL",this.getAttribute("data-downloadurl"))},setGabcLinkSelector=function(e){linkDownloadSelector=e,$(e).bind("dragstart",onDragStart)},regexToneModifiers=/(')|(\.{1,2})|(_{1,4}0?)/g,regexTones=new RegExp("([/ ,;:`]+)|((?:[fF]|[cC][bB]?)[1-4])|(?:(-)?(([A-M])|([a-m]))(([Vv]{1,3})|(s{1,3})|((<)|(>)|(~))|(w)|(o)|(O)|((x)|(y))|(q)|((R)|(r0)|(r(?![1-5])))|(r[1-5])|(\\+))?((?:"+regexToneModifiers.source.replace(/\((?!\?:)/g,"(?:")+")*)(?:\\[([^\\]]*)(?:]|$))?|(z0))","g"),regexTonesSpliceIndex=27,regexToneModifiersCount=4,rtg={whitespace:1,clef:2,initioDebilis:3,tone:4,toneUpper:5,toneLower:6,noteType:7,virga:8,stropha:9,liquescentia:10,ascendingLiquescentia:11,descendingLiquescentia:12,diminutiveLiquescentia:13,quilisma:14,oriscus:15,oriscusReverse:16,accidental:17,flat:18,natural:19,q:20,lineaPunctum:22,lineaPunctumCavum:23,punctumCavum:24,rNumber:25,custos:26,ictus:27,dot:28,episema:29,bracketed:30,autoCustos:31},regexVowel=/(?:[cgq]u|[iy])?([aeiouyáéëíóúýǽæœ]+)/i,transforms=[["/"," ",",",";",":","`",""],["'","_","+",";","|",",",""],[/\//g,/ /g,/,/g,/;/g,/:/g,/`/g,/!/g]],abcs={},_defs=null,defText=null,_defText=null,defChant=null,masks=[],selectedPunctum=-1,selectedNeume=-1,selectedPunctumTag=null,selectedNeumeTag=null,selectedNeumeTextTag=null,syllableGabcIndex=-1,syllableGabcPrefix="",syllableGabcSuffix="",syllableGabcOriginalLength=0,syllableTextIndex=-1,syllableTextPrefix="",syllableTextSuffix="",syllableTextOriginalLength=0,syllableTextTag=null,syllableOffsetCorrection={},_timeoutGabcUpdate=null,_minUpdateInterval=1700,_heightCorrection=0,utf8_bom=String.fromCharCode(239)+String.fromCharCode(187)+String.fromCharCode(191);Header.prototype.toString=function(){var e=[];for(key in this)if("length"!=key&&"original"!=key&&"comments"!=key&&"cValues"!=key&&"string"==typeof this[key]){var t=this[key+"Array"];if(t)for(i in t)e.push(key+": "+t[i]+";");else e.push(key+": "+this[key]+";")}for(key in this.cValues)0!=key.length&&e.push("%"+key+": "+this.cValues[key]+";");for(i in this.comments)try{e.splice(i,0,this.comments[i])}catch(n){}return e.join("\n")+"\n%%\n"};var regexHeaderLine=/^([\w-_]+):\s*([^;\r\n]*)(?:;|$)/i,regexHeaderComment=/^%.*/,gabcProcessTime=0,_nextUpdate=(new Date).getTime(),dontUpdateChant=!1,otherElements=[],_txtWidths={};TagInfo.prototype.span=function(){var e=make("tspan",this.text,fontclass+" "+this.tags.join(" "));return e},TagInfo.prototype.spanV=function(){for(var e=fontclass+" "+this.tags.join(" "),t=make("tspan","",e),n=0;n<this.spans.length;++n){var a=this.spans[n];switch(typeof a){case"object":t.appendChild(make("tspan",a.txt,"versiculum"));break;case"string":t.appendChild(document.createTextNode(a))}}return t};var finishStaff=function(e){var t=e.parentNode,n=parseInt(e.id.match(/\d+$/)[0]),a=e.info,i=a.ltone,s=a.htone;i=3-i,i=0>=i?0:i*spaceheight/2,s-=9,s=0>=s?0:s*spaceheight/2;var r=Math.ceil(.1*staffheight+fontsize+i+s);if(a.vOffset=a.y,a.txtInitial&&a.txtInitial.setAttribute("y",r+a.y),a.txtAnnotation&&a.txtAnnotation.setAttribute("y",a.y+Math.ceil(s)-25),a.eText.setAttribute("y",r),a.eTrans.setAttribute("y",r+fontsize),a.eText.setAttribute("transform","translate("+a.x+","+a.vOffset+")"),a.eTrans.setAttribute("transform","translate("+a.x+","+a.vOffset+")"),t){var l=$(t);
l.append(l.children("text")),t.appendChild(a.eText),t.appendChild(a.eTrans)}if(a.eTrans.childNodes.length>0&&(r+=fontsize),s>0){if(a.vOffset+=s,0==n){var o=0;$(e).children("[id^=neume]").each(function(){o=Math.min(o,this.neume.info.mindy)}),_heightCorrection=o+s}e.setAttribute("transform","translate("+a.x+", "+(a.y+s)+")")}return r},trimStaff=function(e,t){var n,a=$(e).find("use[href=#staff]");if(t)n=t;else{var i=$(e).find("[id^=neume]:last"),s=$(e.parentNode).find("[id^=neumetext]:last");if(href=i.attr("href")){if(!/\:$/.exec(href))return}else if(!/\|$/.exec(i.text()))return;var r=/\d+$/.exec(i.prop("id"))[0],l=/\d+$/.exec(s.prop("id"))[0];if(l>r)return;n=parseFloat(i.attr("x"));var o=i.attr("transform"),c=regexTranslate.exec(o);c&&c[1]&&(n+=parseFloat(c[1])),n+=i[0].neume.wChant}var d="scale("+n+",1)";a.attr("transform",function(e,t){return t.replace(/scale\([^\)]*\)/,d)})},justifyLine=function(e,t,n){var a=0,i=0,s=e.words;if(!n){var r=2*spaceBetweenNeumes;i=svgWidth-e.info.x-r;for(var l,o,c=s.length-1;c>=0&&(!l||!o);)for(var d=s[c--],f=d.length-1;f>=0&&(!l||!o);){var u=d[f--];!l&&u.tagName.match(/^use|text$/i)&&u.neume?l=u:o||!u.tagName.match(/^tspan$/i)||(o=u)}if(l){if(t)a=l.neume.x+(l.neume.transformX||0);else{a=parseFloat($(l).attr("x"));var h=t?l.neume.transform:$(l).attr("transform"),g=regexTranslate.exec(h);g&&g[1]&&(a+=parseFloat(g[1]))}a+=l.neume.wChant}if(o){var m;t&&o.neume?m=o.neume.x:(m=parseFloat($(o).attr("x")),m+=textWidth(o)-r),a=Math.max(a,m)}}if(n||a>0){var p=i-a,v=s.length-1,x=p/v;if(n||p>0)for(;v>=0;)s[v].forEach(function(e){e.neume&&(e.neume.justifyOffset=Math.round(p)),$(e).attr("transform")?(t&&e.neume&&$(e).attr("x",e.neume.x),$(e).attr("transform",function(){return"translate("+Math.round(p+(e.neume&&e.neume.transformX||0))+")"})):$(e).attr("x",function(n,a){return(t?e.neume.x:a?parseFloat(a):0)+Math.round(p)})}),p-=x,--v}},addCustos=function(e,t,n,a){var i=t.info.ftone,s=neume(indices.custos,i),r=e.custos;if(r){if(r.textContent=s,e.custosLedger)try{e.removeChild(e.custosLedger),delete e.custosLedger}catch(l){}}else r=make("text",s),r.setAttribute("class",defChant.getAttribute("class")),r.setAttribute("y",0);(n||"undefined"==typeof n)&&(justifyLine(e,"undefined"!=typeof t.x),n=!0);var o=n?svgWidth-e.info.x-staffheight/15:a;r.setAttribute("x",o),e.appendChild(r),e.custos=t.custos=r;var c=i>10,d=2>i;(c||d)&&(e.custosLedger=t.custosLedger=insertLedger(c,e,r,!0))},boolArray=[!0,!1],ToneInfo=function(e){for(i in e)this[i]=e[i]};!function(){var e,t,n,a,i,s,r,l=!1;getChantFragment=function(l,c){if(void 0!=abcs[l]){var d=abcs[l];return 0==$(c).find("[id='"+l.replace(/\'/g,"\\'")+"']").length&&(c.appendChild($.clone(d.def)),d.mask&&getChantFragment(d.mask,c)),d}var f=void 0;l.indexOf("r")>-1&&(f=l.replace(/r/g,"!"),getChantFragment(f,c)),t=make("text"),i=3,a=0,t.setAttribute("id",l);var u,h,g,m=null,p=0;ledgerA=[],ledgerB=[],n=0,regexInner.lastMatch=0;var v=[];for(s=0,r=0;u=regexInner.exec(l);){e=[];var x=-1;chant=u[0],regexTones.exec("");for(var b;b=regexTones.exec(chant);){++p;var y=[];if(b[regexTonesSpliceIndex])for(var T,C=b[regexTonesSpliceIndex];T=regexToneModifiers.exec(C);){if(T[3]){var S=T[3].match(/0/)?-1:0,A=T[3].length+S-1;T[3]=T[3].slice(S-1);for(var w=1,k=e.length;A>=w&&k>=w;){var N=e[k-w];N.match[rtg.episema]||(N.match[rtg.episema]=T[3],N.episemaLoc=S),++w}}if(T[2]){var A=T[2].length;if(A>1){var N=e[e.length-1];N.match[rtg.dot]||(N.match[rtg.dot]=".")}}$.extend(y,T)}else y=new Array(regexToneModifiersCount);var _=b.index;if(b=b.splice(0,regexTonesSpliceIndex).concat(y.splice(1,y.length-1)).concat(b.splice(1,b.length-1)),b.index=_+u.index,b[rtg.clef]&&(h=b[rtg.clef],g="f"==h[0]?5:1,g+=2*parseInt(h.slice(-1))),tone=b[0],b[rtg.whitespace]){for(var w=0;w<transforms[0].length;++w)tone=tone.replace(transforms[2][w],transforms[1][w]);var L=make("tspan",tone);L.setAttribute("offset",b.index),L.setAttribute("len",b[0].length),s&&(L.setAttribute("dx",s),s=0),r&&(L.setAttribute("dy",r),r=0),t.appendChild(L),a=Math.max(a,/[`,]/.exec(b[rtg.whitespace])&&9.5||0),v.push(L=new ToneInfo({match:[]})),L.match[rtg.whitespace]=b[rtg.whitespace]}else{var I=parseInt(b[rtg.tone]||b[rtg.clef]&&b[rtg.clef].slice(0,1),23)-10,O=null;b[rtg.tone]&&1==b[rtg.tone].length?(i=Math.min(i,I),a=Math.max(a,I),null!=m||b[rtg.accidental]||(m=I)):a=Math.max(a,b[rtg.clef]&&2*parseInt(b[rtg.clef].slice(-1))+2||0);var P=/^cs\:([^\]]+)/.exec(b[rtg.bracketed]);P&&(O=P[1]),I>10?ledgerA.push(p-1):2>I&&ledgerB.push(p-1);var L=new ToneInfo({match:b,index:I,relativeTone:0>x?0:I-x,modifiers:b[rtg.noteType],clef:b[rtg.clef],episemaLoc:b[rtg.episema]&&b[rtg.episema].match(/0/)?-1:0,diamond:b[rtg.toneUpper]?!0:!1,markings:b[rtg.ictus]||b[rtg.dot]||b[rtg.episema],liq:b[rtg.diminutiveLiquescentia],accidental:b[rtg.accidental],choralSign:O});e.push(L),v.push(L),x=I}}for(var w=0;w<e.length;++w)w=o(w)}return c.appendChild(t),abcs[l]={ltone:i,htone:a,ftone:m,tones:v,startsWithAccidental:v.length>0&&v[0].match[rtg.accidental]?!0:!1,mask:f,clef:h,clefTone:g,mindy:n,ledgerA:ledgerA,ledgerB:ledgerB,def:t}};var o=function(o){var c=function(e,t,n){n||(n=t),-1==e?(h+=neume(indices.episema_below,t),i=Math.min(i,t-1)):(h+=neume(indices.episema_above,n),a=Math.max(a,n+1))},d=function(e,t){1==e?(h+=neume(indices.ictus_above,t),a=Math.max(a,t+1)):(h+=neume(indices.ictus_below,t),i=Math.min(i,t-1))},f=function(e,t,n){var a=e.choralSign,i=e.index,l=make("tspan",a),o=textWidth(a,"choral-sign"),c=getChantWidth($(n).text());e.match[rtg.episema]&&-1!=e.episemaLoc&&(i+=2,i%2&&--i);var d=t?1:c>2*notewidth?-c+(notewidth-o)/2:(-o-notewidth)/2,f=-3+(1-Math.floor(i/2)+(t?1:0))*(staffheight/4);1==i%2&&(f-=2),d+=s,f+=r,l.setAttribute("class","choral-sign"),l.setAttribute("dx",d),l.setAttribute("dy",f),s-=o+d,r-=f,t&&l.setAttribute("transform","translate("+notewidth+",0)"),n.appendChild(l)},u=function(e){if(e&&h&&0!=h.length){var n=make("tspan",h);n.setAttribute("offset",e.match.index),n.setAttribute("len",e.match[0].length),s&&(n.setAttribute("dx",s),s=0),r&&(n.setAttribute("dy",r),r=0);for(var a=1;a<arguments.length;++a)n.setAttribute("len"+a,arguments[a].match[0].length);arguments.length>1&&n.setAttribute("count",arguments.length),t.appendChild(n);for(var a=0;a<arguments.length;++a){var e=arguments[a];e.choralSign&&f(e,1==a||l,n)}h="",l=!1}},h="",g=1,m=1,p="",v=e[o],x=e.length>o+1?e[o+1]:null,b=e.length>o+2?e[o+2]:null,y=e.length>o+3?e[o+3]:null,T=o>0?e[o-1]:null,C=indices.punctum;if(o>0&&0==v.relativeTone&&(h+="'"),v.diamond){C=v.liq?indices.diamond_tilde:indices.diamond;var S=Math.abs(v.relativeTone);T&&T.diamond&&2==S&&(h+="'"),x&&!x.diamond&&(p="-")}else{if(v.clef){var A=[n];return t.appendChild(makeClefSpan(v,A)),n=A[0],o}if(v.modifiers){if(v.match[rtg.accidental]){0==o&&(startsWithAccidental=!0);var w=v.match[rtg.flat]?"flat":"natural";return h+=neume(indices[w],v.index)+"-",u(v),o}v.match[rtg.virga]?(C=indices.v,m=v.match[rtg.virga].length,p="'"):v.match[rtg.stropha]?(C=indices.s,m=v.match[rtg.stropha].length,p="'"):indices[v.modifiers[0]]&&(C=indices[v.modifiers[0]],x&&x.relativeTone>0&&x.relativeTone<=5&&"w"==v.modifiers&&(!b||b.relativeTone>=0)&&(h+=neume(C,v.index),v.match[rtg.ictus]&&d(-1,v.index),v.match[rtg.episema]&&c(-1,v.index),u(v),x.relativeTone>1&&(h+=neume(indices.connecting_line,v.index,x.index)),++o,C=indices.topPartPodatus,v=x,v.episemaLoc=1))}else if(x&&!x.diamond&&(!x.modifiers||x.liq))if(x.relativeTone>0&&x.relativeTone<=5){if(b&&!b.diamond&&(!b.modifiers||"~"==b.modifiers)&&b.relativeTone<0&&b.relativeTone>=-4)if(C=indices.punctum,!b.modifiers&&y&&y.relativeTone>=1&&y.relativeTone<=5)--o,v.episemaLoc=0,x.episemaLoc=0;else{h+=neume(C,v.index);var k=x.index,N=Math.min(v.index,b.index);v.match[rtg.episema]&&c(v.episemaLoc,N,k),v.match[rtg.ictus]&&(d(v.episemaLoc,v.index),v.match[rtg.ictus]=void 0),u(v),x.relativeTone>1&&(h+=neume(indices.connecting_line,v.index,x.index)),"~"==b.modifiers?(--o,C=void 0):(h+=neume(C,x.index),x.match[rtg.episema]&&c(v.episemaLoc,N,k),x.match[rtg.ictus]&&(d(x.episemaLoc,x.index),x.match[rtg.ictus]=void 0),u(x),b.relativeTone<-1&&(h+=neume(indices.connecting_line,b.index,x.index)),v=b,b.match[rtg.episema]&&(v.episemaTone=-1==b.episemaLoc?N:k),"~"==b.modifiers&&(C=indices.lower_tilde),g=3,++o)}else if(x.relativeTone<=5){v.episemaLoc=-1,x.episemaLoc=1,C=indices.topPartPodatus,g=2,b&&b.relativeTone<=0&&(p="-"),x.liq?(h+=neume(indices["<"],v.index),C=indices.upper_tilde):(h+=neume(indices.bottomPartPodatus,v.index),l=!0),u(v),x.relativeTone>1&&(h+=neume(indices.connecting_line,v.index,x.index));var _=v;v=x,x=_}++o}else if(x.relativeTone<0&&x.relativeTone>=-5){if(!v.markings&&b&&!b.diamond&&(!b.modifiers||"~"==b.modifiers)&&b.relativeTone>=1&&b.relativeTone<=4&&x.relativeTone>=-4){if(v.relativeTone>=2&&v.relativeTone<=5)h+=neume(indices.connecting_line,v.index-v.relativeTone,v.index);else if(v.relativeTone<1){var L=Math.max(-x.relativeTone,1);h+=(t.childNodes.length>0?"-":"")+neume(indices.decorative_line,v.index-L,v.index)}"~"==b.modifiers?(--o,h+=neume(C,v.index),u(v),h+=neume(indices.connecting_line,x.index,v.index),C=void 0):(h+=neume(indices.porrectus,v.index,x.index),u(v,x),h+=neume(indices.decorative_line,x.index,b.index),x.episemaLoc=-1,!y||y.relativeTone>=0||y.relativeTone<-5?(C=indices.topPartPodatus,b.episeamLoc=1,v=b,g=3,++o):(C=void 0,b.connectingLine=!0,g=2))}else{if(g=2,x.liq){var L=Math.min(-x.relativeTone,2);h+=neume(indices.decorative_line,v.index-L,v.index),h+=neume(indices[">"],v.index),u(v),C=indices.lower_tilde}else v.relativeTone>0&&v.relativeTone<=5&&("w"==T.modifiers||v.connectingLine)?v.relativeTone>1&&(h+=neume(indices.connecting_line,T.index,v.index)):h+=neume(indices.decorative_line,x.index,v.index),h+=neume(indices.punctum,v.index),v.match[rtg.episema]&&(c(v.episemaLoc,x.index,v.index),g=1),v.match[rtg.ictus]&&(d(v.episemaLoc,v.index),v.match[rtg.ictus]=void 0),x.match[rtg.episema]&&(_=-1==x.episemaLoc?N:k,v.episemaTone=1,-1!=x.episemaLoc&&(x.episemaTone=v.index)),v.match[rtg.dot]&&(x.match[rtg.dot]?1==x.match[rtg.dot].length&&(x.match[rtg.dot]=".."):(h+=neume(indices.dot,v.index),g=1)),u(v);x.relativeTone<-1&&(h+=neume(indices.connecting_line,x.index,v.index));var _=v;v=x,x=_}++o}}var _=neume(C,v.index);if(m>1&&(_=(_+"'").repeat(m).slice(0,-1)),h+=_,v.match[rtg.ictus]&&d(v.episemaLoc,v.index),v.match[rtg.episema]){var _=v.episemaTone||v.index;c(v.episemaLoc,_)}g>1&&(x.match[rtg.ictus]&&d(x.episemaLoc,x.index),x.match[rtg.episema]&&!v.episemaTone&&c(x.episemaLoc,x.index));var I,O;g>1&&(I=Math.min(x.index,v.index),O=Math.max(x.index,v.index),(O-I>=2||0==I%2)&&(I=void 0));var _=v.match[rtg.dot];return _?(h+=v.index==I?neume(indices.dot,I-1):neume(indices.dot,v.index),_=_.length):_=0,x&&(_>1||g>1&&(_=x.match[rtg.dot]))&&(h+=x.index==I?neume(indices.dot,I-1):neume(indices.dot,x.index)),_&&e[o+1]&&(p+="--"),h+=p,C&&u(v),o}}();var gradients={},playTone=function(){console.warn("Audiolet library not loaded.")},playScore=playTone,stopScore=playTone,baseFreq=370;$(function(){$.fn.autoSizeInput=function(e){return e=$.extend({maxWidth:1e3,minWidth:0,comfortZone:0},e),this.filter("input:text").each(function(){var t=e.minWidth||$(this).width(),n="",a=$(this),i=$("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:a.css("fontSize"),fontFamily:a.css("fontFamily"),fontWeight:a.css("fontWeight"),letterSpacing:a.css("letterSpacing"),whiteSpace:"nowrap"}),s=function(){if(n!==(n=a.val())){var s=n.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");i.html(s);var r=i.width(),l=r+e.comfortZone>=t?r+e.comfortZone:t,o=a.width(),c=o>l&&l>=t||l>t&&l<e.maxWidth;c&&(a.width(l),a.trigger("autoSizeInput"))}};i.insertAfter(a),$(this).bind("keyup blur update",s).bind("keydown",function(e){window.setTimeout(function(){s.apply(this,[e])},1)})}),this};var t=function(){try{var e=new Audiolet,t=function(t,n,a){AudioletGroup.apply(this,[e,0,1]),this.sine=new Sine(e,t),this.gain=new Gain(e,.01*a),this.env=new PercussiveEnvelope(e,1,.3,.3*(n||1),function(){this.audiolet.scheduler.addRelative(0,this.remove.bind(this))}.bind(this)),this.envMulAdd=new Multiply(e,.002*a,0),this.sine.connect(this.gain),this.gain.connect(this.outputs[0]),this.env.connect(this.envMulAdd),this.envMulAdd.connect(this.gain,0,1)};extend(t,AudioletGroup);var n=function(n,a,i){var s=new t(n,a,i);s.connect(e.output)},a={0:0,1:2,2:4,3:5,4:7,5:9,6:11};playTone=function(e,t,i,s){var r=baseFreq;for(t=e==t;0>e;)e+=7,r/=2;for(;e>=7;)e-=7,r*=2;e>0&&(r*=Math.pow(2,(a[e]-(t?1:0))/12)),n(r,i,s)};var i=!1;tempo=150,setTempo=function(e){tempo=e||150},setRelativeTempo=function(e){tempo+=e,0>=tempo&&(tempo=150)};var s;playScore=function(t){for(var n=y,a=t?0:selectedPunctum||0;s&&s.next(););s=new PSequence(n.tones,1,a),i=!0,e.scheduler.setTempo(tempo),e.scheduler.play([s],1,function(t){for(var r;!(i=i&&a<n.tones.length)||!(r=t.play(a));)if(++a,!(t=s.next()))return S(-1),i=!1,void 0;S(a,!0),r&&e.scheduler.setTempo(tempo/r),++a})},stopScore=function(){i=!1}}catch(r){console.warn(r)}},n=function(){if("function"==typeof Audiolet)try{t()}catch(e){}else $.getScript("audiolet.js",t)};"function"==typeof Sink?n():$.getScript("sink.js",n),0==$("link[href=style\\.css]").length&&$(document.head).append($('<link rel="stylesheet" type="text/css" href="style.css">'));var a=$("#tbl");if(a)for(var i=57568;65535>i;i+=16){var s=document.createElement("row"),r=document.createElement("td"),l=document.createElement("td");r.innerText="0x"+i.toString(16);for(var o="",c=0;16>c;++c)o+=String.fromCharCode(i+c)+"_";l.innerText=o,l.className="caeciliae",s.appendChild(r),s.appendChild(l),a.append(s)}if("function"==typeof document.createElementNS){_svg=svg=document.createElementNS(svgns,"svg"),svg.setAttribute("style","width:100%;height:0"),setPrintFont=function(e){$(svg).find(".caeciliae,.caeciliae-print").attr("class",e?"caeciliae-print":"caeciliae")},_defs=document.createElementNS(svgns,"defs"),defText=make("text",""),defText.setAttribute("class","goudy"),_defs.appendChild(defText),_defText=make("text",""),_defText.setAttribute("class","goudy"),_defs.appendChild(_defText),defChant=make("text","p"),defChant.setAttribute("class","caeciliae"),_defs.appendChild(defChant),defChantSvg=make("text","p"),defChantSvg.setAttribute("class","caeciliaeSvg"),_defs.appendChild(defChantSvg);var d=make("linearGradient");d.setAttribute("gradientUnits","objectBoundingBox"),d.setAttribute("id","gradRedBlack");var f=make("stop");f.setAttribute("offset","0"),f.setAttribute("stop-color","#e22"),d.appendChild(f),f=make("stop"),f.setAttribute("offset","100"),f.setAttribute("stop-color","#000"),d.appendChild(f),gradients.RedBlack=d,d=make("linearGradient"),d.setAttribute("gradientUnits","objectBoundingBox"),d.setAttribute("id","gradBlackRed");var f=make("stop");f.setAttribute("offset","0"),f.setAttribute("stop-color","#000"),d.appendChild(f),f=make("stop"),f.setAttribute("offset","100"),f.setAttribute("stop-color","#e22"),d.appendChild(f),gradients.BlackRed=d;var u;if(staffInFont)u=document.createElementNS(svgns,"text"),u.textContent="'",u.setAttribute("transform","scale(0.5,1)");else{u=document.createElementNS(svgns,"g");var h=1,g=document.createElementNS(svgns,"path"),m="h1v"+h+"h-1zm0 -"+spaceheight;g.setAttribute("d","M0 0"+m.repeat(4)),u.appendChild(g);var p=document.createElementNS(svgns,"g");g=document.createElementNS(svgns,"path"),g.setAttribute("d","M0 "+spaceheight+m),p.appendChild(g),p.setAttribute("id","ledgerb"),_defs.appendChild(p),p=document.createElementNS(svgns,"g"),g=document.createElementNS(svgns,"path"),g.setAttribute("d","M0 "+4*-spaceheight+m),p.appendChild(g),p.setAttribute("id","ledgera"),_defs.appendChild(p)}u.setAttribute("id","staff"),_defs.appendChild(u),svg.appendChild(_defs),textElem=document.createElementNS(svgns,"g"),textElem.setAttribute("transform","translate(0,"+staffoffset+")"),textElem.setAttribute("class","caeciliae"),svg.appendChild(textElem);var v=$("#chant-preview,[id$=-preview][for]");if(0==v.length)$(document.body).append(svg);else{v.append(svg),v.append('<input type="text" id="txtSyllableGabc" style="display:none;position:absolute;padding:2px;width:5px;font-family:monospace;font-size:11pt;border:1px solid #aaa" spellcheck="false">'),v.append('<input type="text" id="txtSyllable" class="goudy" style="display:none;position:absolute;padding:2px;width:5px;border:1px solid #aaa" spellcheck="false">'),lastClefBeforeNeume=function(e,t){var n,a={clefTone:9};for(n in t.clefs){if(!(e>n))break;a=t.clefs[n]}return a},lastClefBeforePunctum=function(e,t){var n,a={clefTone:9};for(n in t.clefs)try{var i=parseInt($(t).find("#neume"+n).children()[0].id.match(/\d+$/)[0]);if(!(e>i))break;a=t.clefs[n].info}catch(s){}return a};var x=function(e,t){var n,a=null;for(n in t.accidentals){if(!(e>=n))break;a=t.accidentals[n]}return a};ToneInfo.prototype.isPlayable=function(){return!this.clef&&!this.accidental&&"number"==typeof this.index},ToneInfo.prototype.play=function(e){var t=y,n=t.timings,a=t.volumes;if(clefIndex=lastClefBeforePunctum(e,t).clefTone,setDuration=n&&n[e],volume=a[e]||100,duration=setDuration||this.match&&(this.match[rtg.dot]||this.match[rtg.episema])?2:(this.match[rtg.virga]||"v").length,longDuration=0,setDuration)duration=setDuration.length,longDuration=duration+(setDuration.restAfter||0);else{if(1==duration){var i=$(t).find("[id=punctum"+(1+e)+"]");i.length&&(i=i[0].tone,i&&i.match[rtg.quilisma]&&(duration=2))}longDuration=duration}return this.clef||this.accidental||"number"!=typeof this.index?!1:(playTone(this.index-clefIndex,x(e,t),duration,volume),longDuration)};var b=function(e){var t=selectedPunctumTag,n=y,a=$("#"+$(n).parent().attr("for"));if(0==a.length&&(a=$("#editor")),t){var i=t.parentNode,s=selectedPunctum-/^punctum(\d+)$/.exec(i.childNodes[0].id)[1],r=i.neume,l=r.info.tones[s];if(l&&l.match){var o,c,d=l.match[rtg.tone];if(d){var f=l.index+e;if(0>f?f=0:f>12&&(f=12),e=f-l.index,0==e)return;o=String.fromCharCode(d.charCodeAt(0)+e)}else{c=l.match[rtg.clef],d=parseInt(c.slice(-1));var o=d+e;if(1>o?o=1:o>4&&(o=4),e=o-d,0==e)return;c=c.slice(0,-1)+o}var u=a.val(),h=getHeaderLen(u);h+=r.index;var g=u.slice(0,h);u=u.slice(h),h=C(!0);var m=h+l.match[0].length,p=u.slice(0,h);p+=u.slice(h,m).replace(d,o),h=r.gabc.length,p+=u.slice(m,h),u=g+p+u.slice(h),r.gabc=p;var v=r.info,x=r.info=getChantFragment(p,$(n).find("defs")[0]);if(c)for(L in n.clefs[selectedNeume].clefs){var b=n.clefs[selectedNeume].clefs[L];b.setAttributeNS(xlinkns,"href","#"+c)}stopScore(),x.tones[s].play(selectedPunctum);var T=$(x.def).clone()[0];T.neume=r,T.setAttribute("id",i.id),T.setAttribute("x",i.getAttribute("x")),T.setAttribute("y",i.getAttribute("y")),T.setAttribute("transform",i.getAttribute("transform")),$(i).replaceWith(T),r.wChant=useWidth(T),processLedger(r,T),relayoutChant(n),0==s&&r.custos&&addCustos(r.custos.parentNode,r);var S=T.parentNode,A=S.info.htone,w=S.info.ltone;v.htone<=r.info.htone?S.info.htone=Math.max(S.info.htone,r.info.htone):(S.info.htone=10,$(S).find("[id^=neume]").each(function(){S.info.htone=Math.max(S.info.htone,this.neume.info.htone)})),v.ltone>=r.info.ltone?S.info.ltone=Math.min(S.info.ltone,r.info.ltone):(S.info.ltone=3,$(S).find("[id^=neume]").each(function(){S.info.ltone=Math.min(S.info.ltone,this.neume.info.ltone)}));var k=$(S.parentNode).children("#system0")[0].info.y;if(c||A!=S.info.htone||w!=S.info.ltone)for(var N=finishStaff(S),_=staffoffset+N+verticalSpace+S.info.y,L=parseInt(S.id.match(/\d+$/)[0])+1;S=$(S).siblings("#system"+L)[0];)S.info.y=_,N=finishStaff(S),_=staffoffset+N+verticalSpace+S.info.y,++L;n.setAttribute("height",$(n).children("g")[0].getBBox().height+k+_heightCorrection-_defText.getExtentOfChar("q").height),s=selectedPunctum-s,selectedPunctumTag=null,s=setUpPunctaIn(T,s,n),selectedNeumeTag=T,a.val(u)}}},y=svg,T=function(e){var t=e.firstElementChild,n=t&&parseInt(t.getAttribute("offset"))||0;return e.neume.index+n},C=function(e){if(null!=selectedPunctum&&selectedPunctumTag){var t=selectedPunctumTag,n=selectedPunctum-t.id.match(/^punctum(\d+)$/)[1],a=t.parentNode,i=parseInt(t.getAttribute("offset"))||0,s=parseInt(t.getAttribute("len"))||3;return n&&(i+=s,s=parseInt(t.getAttribute("len1"))),e?i:(selectGabc(a.neume.index+i,s,y),void 0)}},S=function(e,t,n){if(n?y=n:n=y,e=parseInt(e),0>e&&(e=-1),e!=selectedPunctum){var a,i=0;if(0>e)t=!0,a=$();else if(a=$(n).find("#punctum"+e),0==a.length&&(i=1,--e,a=$(n).find("#punctum"+e),0==a.length||2!=a.attr("count")))return selectedPunctumTag=null,void 0;selectedPunctum=e+i,selectedPunctumTag=a[0];var s=a.parent().attr("id");if(s&&(s=/neume(\d+)/i.exec(s)),selectedNeume=s?parseInt(s[1]):-1,selectedNeumeTag=selectedPunctumTag&&selectedPunctumTag.parentNode,selectedNeumeTextTag=$(n).find("#neumetext"+selectedNeume),$(n).find(".selectable").attr("style","").attr("class",function(e,t){return t.replace(/(^|\s+)selected(?=\s+|$)/g,"")}),$(n).find(".neume"+selectedNeume).attr("class",function(e,t){return t+" selected"}),a.attr("class","selectable selected"+(2==a.attr("count")?"-"+(1+i):"")),selectedNeumeTextTag.attr("class","selectable selected"),2==a.attr("count")&&setGradient(a[0],i),!t){stopScore();var r=selectedPunctum-/^punctum(\d+)$/.exec(selectedNeumeTag.childNodes[0].id)[1];selectedNeumeTag.neume.info.tones[r].play(selectedPunctum)}}},A=function(e){var t=$(y).find("#neume"+e+">tspan");return punctumToSelect=/punctum(\d+)/i.exec(t.attr("id")),punctumToSelect?(S(parseInt(punctumToSelect[1]),!0),!0):(selectedNeume=parseInt(e),selectedNeumeTag=$(y).find("#neume"+e).get(0),selectedNeumeTextTag=$(y).find("#neumetext"+e),$(y).find(".selectable").attr("style","").attr("class",function(e,t){return t.replace(/(^|\s+)selected(?=\s+|$)/g,"")}),$(y).find(".neume"+selectedNeume).attr("class",function(e,t){return t+" selected"}),selectedNeumeTextTag.attr("class","selectable selected"),selectedNeumeTag)},w=function(){syllableGabcIndex=-1,syllableGabcPrefix="",syllableGabcSuffix="",syllableGabcOriginalLength=0,$("#txtSyllableGabc").hide()},k=function(){syllableTextIndex=-1,syllableTextPrefix="",syllableTextSuffix="",syllableTextOriginalLength=0,$("#txtSyllable").hide()},N=function(){var e={my:"center bottom",at:"center top",of:selectedNeumeTag,collision:"fit"},t=selectedNeumeTag.neume.info.htone<8.5?8:selectedNeumeTag.neume.info.htone,n=5+(12-t)*staffheight/8;$.ui.version.match(/^1\.8/)?e.offset="0 "+n:e.my+="+"+n,$("#txtSyllableGabc").position(e)},_=function(){var e=syllableTextTag||selectedNeumeTextTag;if(e&&e.length){var t=$("#txtSyllable"),n=t.val(),a=e.text(),i=e.parent(),s=i.offset(),r=parseFloat(i.children().first().attr("x")),l={top:s.top-4,left:s.left-r-3+e.get(0).x.baseVal.getItem(0).value};if(a.slice(0,n.length)!=n){var o=e.children().last(),c=o.text(),d=t.width(),f="-"==c?o.width():textWidth(c.match(/\s*$/)[0]),u=e.width()-f;l.left+=u-d+1}t.offset(l)}},L=function(e){var t,n,a={my:"center bottom",at:"center top",collision:"fit"};if(1==e){a.of=selectedNeumeTag,a.my="left bottom",a.at="right top";var i;$("#txtSyllableGabc").is(":visible")?(syllableGabcPrefix+=$("#txtSyllableGabc").val(),i=syllableGabcSuffix):(syllableGabcPrefix=syllableTextPrefix+$("#txtSyllable").val(),i=syllableTextSuffix);var s=1+i.indexOf(")");0>=s&&(s=i.length),syllableGabcPrefix+=i.slice(0,s)+" (",syllableGabcSuffix=")"+i.slice(s),n="",++selectedNeume,$("#editor").val(syllableGabcPrefix+syllableGabcSuffix).keyup()}else{var r=e||selectedNeumeTag;a.of=r,syllableGabcIndex=T(r),syllableOffsetCorrection&&syllableOffsetCorrection.afterNeume<=selectedNeume&&(syllableGabcIndex+=syllableOffsetCorrection.offset),t=$("#editor").val(),syllableGabcIndex+=getHeaderLen(t);var l=$(r).children().last();if(syllableGabcOriginalLength=r.neume&&""==r.neume.gabc?0:parseInt(l.attr("offset"))+parseInt(l.attr("len")),isNaN(syllableGabcOriginalLength)){var o=/^([^\)]*)\)/.exec(t.slice(syllableGabcIndex));syllableGabcOriginalLength=o?o[1].length:0}n=t.slice(syllableGabcIndex,syllableGabcIndex+syllableGabcOriginalLength),syllableGabcPrefix=t.slice(0,syllableGabcIndex),syllableGabcSuffix=t.slice(syllableGabcIndex+syllableGabcOriginalLength)}tone=a.of.neume.info.htone<8.5?8:a.of.neume.info.htone,a.my+="+"+(5+(12-tone)*staffheight/8),$("#txtSyllableGabc").show().val(n).position(a).trigger("update").select()},I=function(e){var t=e||selectedNeumeTextTag,n=t.get(0),a=$("#txtSyllable");syllableTextIndex=parseInt(n.getAttribute("selectIndex")),syllableOffsetCorrection&&syllableOffsetCorrection.afterNeume<selectedNeume&&(syllableTextIndex+=syllableOffsetCorrection.offset);var i=parseInt(n.getAttribute("selectLen")),s=$("#editor").val();syllableTextIndex+=getHeaderLen(s);var r=s.slice(syllableTextIndex,syllableTextIndex+i);syllableTextPrefix=s.slice(0,syllableTextIndex),syllableTextSuffix=s.slice(syllableTextIndex+i),syllableTextOriginalLength=i,a.show().val(r).trigger("update"),e?syllableTextTag=e:a.select(),_()},O=function(){var e=this.value.length-syllableGabcOriginalLength;syllableOffsetCorrection=0==e?{}:{afterNeume:selectedNeume+.5,offset:e}},P=function(){var e=this.value.length-syllableTextOriginalLength;syllableOffsetCorrection=0==e?{}:{afterNeume:selectedNeume,offset:e}};$(document).on("click","tspan.selectable[id^=punctum]",function(e){S(/punctum(\d+)/i.exec(this.id)[1],!1,$(e.target).parents("svg")[0],!e.altKey),e.altKey&&L()}).on("dblclick","tspan.selectable[id^=punctum]",function(e){S(/punctum(\d+)/i.exec(this.id)[1],!1,$(e.target).parents("svg")[0],!1),L()}).on("mousedown","tspan.selectable[id^=punctum]",function(e){2==e.which&&(S(/punctum(\d+)/i.exec(this.id)[1],!1,$(e.target).parents("svg")[0],!0),L(),e.preventDefault())}).on("click","tspan.selectable[id^=neumetext]",function(){A(/neumetext(\d+)/i.exec(this.id)[1]),I()}).on("mouseenter","tspan.selectable[id^=neumetext]",function(){(gabcSettings.showSyllableEditorOnHover&&!$("#txtSyllable").is(":visible")||syllableTextTag)&&I($(this))}),$("#txtSyllableGabc").on("blur",w).keyup(function(){var e=syllableGabcPrefix+$(this).val()+syllableGabcSuffix;$("#editor").val(e).keyup()}).keydown(function(e){switch(e.which){case 27:this.blur();break;case 40:I(),e.preventDefault();break;case 66:(e.ctrlKey||e.altKey)&&(e.preventDefault(),L(1));break;case 37:this.selectionStart==this.selectionEnd&&0==this.selectionStart&&(A(selectedNeume-1),L(),this.selectionStart=this.value.length,e.preventDefault());break;case 39:this.selectionStart==this.selectionEnd&&this.selectionStart==this.value.length&&(A(selectedNeume+1),L(),this.selectionStart=this.selectionEnd=0,e.preventDefault());break;case 9:A(selectedNeume+(e.shiftKey?-1:1)),L(),e.preventDefault()}}).on("autoSizeInput",N).keydown(function(){var e=this;window.setTimeout(function(){O.apply(e)},1)}).autoSizeInput();var E=function(e,t){selectedNeumeTextTag=[];for(var n=1;n>=0&&0==selectedNeumeTextTag.length&&selectedNeumeTag;)if(n=selectedNeume+e,!A(n)){var a=$("#txtSyllable");return syllableTextPrefix=$("#editor").val()+(t?" ":""),syllableTextSuffix="()",syllableTextOriginalLength=0,a.show().val("").trigger("update").select(),void 0}I()};$("#txtSyllable").on("mouseleave",function(){syllableTextTag&&(syllableTextTag=null,$(this).hide())}).on("blur",k).click(function(){syllableTextTag&&(A(/neumetext(\d+)/i.exec(syllableTextTag.get(0).id)[1]),syllableTextTag=null)}).keydown(internationalTextBoxKeyDown).keyup(function(){var e=syllableTextPrefix+$(this).val()+syllableTextSuffix;$("#editor").val(e).keyup()}).keydown(function(e){switch(e.which){case 27:this.blur();break;case 38:L(),e.preventDefault();break;case 66:(e.ctrlKey||e.altKey)&&L(1);break;case 37:this.selectionStart==this.selectionEnd&&0==this.selectionStart&&(E(-1),this.selectionStart=this.value.length,e.preventDefault());break;case 39:this.selectionStart==this.selectionEnd&&this.selectionStart==this.value.length&&(E(1),this.selectionStart=this.selectionEnd=0,e.preventDefault());break;case 32:this.selectionStart==this.selectionEnd&&this.selectionStart==this.value.length&&(e.preventDefault(),E(1,!0));break;case 9:E(e.shiftKey?-1:1),e.preventDefault()}}).on("autoSizeInput",_).keydown(function(){var t=this;window.setTimeout(function(){P.apply(t,[e])},1)}).autoSizeInput({comfortZone:1});var M=function(e){if(27==e.which)return stopScore(),w(),void 0;if(e.target.tagName.match(/textarea|input|select/i))return"txtSyllableGabc"!=e.target.id&&"txtSyllable"!=e.target.id&&S(-1),void 0;var t=selectedPunctum;if(e.ctrlKey){var n=selectedNeume;switch(e.which){case 37:--n;break;case 39:++n;break;case 38:return b(2),e.preventDefault(),void 0;case 40:return b(-2),e.preventDefault(),void 0;case 13:return j(),void 0;case 32:return playScore(),void 0;case 107:return setRelativeTempo(1),void 0;case 109:return setRelativeTempo(-1),void 0;default:return}A(n)}else{switch(e.which){case 37:--t;break;case 39:++t;break;case 38:return b(1),e.preventDefault(),void 0;case 40:return b(-1),e.preventDefault(),void 0;case 13:return L(),e.preventDefault(),void 0;case 32:return playScore(!0),e.preventDefault(),void 0;case 107:return setRelativeTempo(10),e.preventDefault(),void 0;case 109:return setRelativeTempo(-10),e.preventDefault(),void 0;default:return}S(t)}};$(document).keydown(M)}var G=[],B=0,D=0;window.updateGabc=updateGabc=function(){var e=$(".jgabc:visible");e.each(function(e,t){var n=$(t),a=n.clone().toggleClass("jgabc jgabc-svg").text("");n.hide(),$(svg).clone().appendTo(a),n.after(a);var i=n.attr("src");i&&(Y=200,++B,$.get(i,function(e){n.html(e),++D==B&&(Y=0,J(),H(0,!0,!0))}))}),G=$(".jgabc"),setTimeout(J,100)};var F=null,W=null,H=function(e,t,n){if(j(),F&&clearTimeout(F),!t){var a=500;return F=setTimeout(function(){H(null,!0)},a),void 0}F=null,$.each(G,function(e,t){var a=$(t).next(".jgabc-svg").find("svg")[0];a&&(t.innerHTML.match(/^\s*$/)||n&&t.hasSvg||(updateChant(t.innerHTML,a,!0),t.hasSvg=!0))})},U=function(e){if(W&&clearTimeout(W),!e){var t=500;return W=setTimeout(function(){U(!0)},t),void 0}W=null;try{relayoutChant(svg)}catch(n){}$.each(G,function(e,t){var n=$(t).next(".jgabc-svg").find("svg")[0];n&&relayoutChant(n)}),$.each(otherElements,function(e,t){var n=$(t),a=n.is("svg")?n[0]:n.find("svg")[0];a&&(relayoutChant(a),n.trigger("relayout"))})};updateAllChantWidth=navigator.userAgent.match(/\bChrome\b/)?function(){U(!0)}:function(){U()};var j=function(){updateChant($("#editor").val(),svg)};forceUpdateChant=function(){updateChant($("#editor").val(),svg,!0)};var R=function(e){return e.stopPropagation(),e.preventDefault(),!1},q=function(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,q)},z=function(e){e.stopPropagation(),e.preventDefault();var t,n=$(this),a=e.originalEvent.dataTransfer.files.length,i=uuid&&uuid.v4?uuid.v4():q();for(t=0;a>t;++t){var s=e.originalEvent.dataTransfer.files[t],r=new FileReader;r.onload=function(e){var t=processDraggedFile(e.target.result);1==a&&n.val(t).keyup(),"function"==typeof processGabc&&processGabc(t,i,a)},r.readAsText(s)}};$("#editor").keyup(j).bind("dragover",R).bind("drop",z),$(window).resize(updateAllChantWidth);var K=0,V=0,Z=0,X=0,Y=0,J=function(){if(svg)if(svg.parentNode&&0==svg.parentNode.clientWidth)setTimeout(J,100);else{K=textWidth("abcdefghijklmnopqrstuvwxyz",fontclass,!0);var e=getChantWidth("4q5P"),t=getChantWidth("P");notewidth=getChantWidth("p"),Z=getChantWidth("p p p p p p p p p p p p p p p"),e==t?(neume=_neumeLig,indices=_indicesLig,makeClefSpan=_clefSpanLig):(neume=_neumeChar,indices=_indicesChar,makeClefSpan=_clefSpanChar),K!=V&&(_txtWidths={},V=K,forceUpdateChant(),H()),Z!=X&&(X=Z,forceUpdateChant(),H()),++Y<100&&setTimeout(J,300)}};setTimeout(J,100)}});var processDraggedFile=function(e){return e};window.updateChant=updateChant;var neume=_neumeChar,indices=_indicesChar,makeClefSpan=_clefSpanChar,internationalTextBoxKeyDown=function(){var e={222:{"false":{a:"á",e:"é",i:"í",o:"ó",u:"ú",y:"ý",A:"Á",E:"É",I:"Í",O:"Ó",U:"Ú",Y:"Ý","æ":"ǽ","œ":"oé","Æ":"Ǽ","Œ":"Oé"},"true":{a:"ä",e:"ë",i:"ï",o:"ö",u:"ü",y:"ÿ",A:"Ä",E:"Ë",I:"Ï",O:"Ö",U:"Ü","æ":"aë","œ":"oë","Æ":"Aë","Œ":"Oë"}},69:{"false":{a:"æ",o:"œ",A:"Æ",O:"Œ"},"true":{a:"æ",o:"œ",A:"Æ",O:"Œ"}},8:{"false":{"†":"+","æ":"ae","œ":"oe","Æ":"Ae","Œ":"Oe","á":"a","é":"e","í":"i","ó":"o","ú":"u","ý":"y","Á":"A","É":"E","Í":"I","Ó":"O","Ú":"U","Ý":"Y","ä":"a","ë":"e","ï":"i","ö":"o","ü":"u","ÿ":"y","Ä":"A","Ë":"E","Ï":"I","Ö":"O","Ü":"U","Ǽ":"Aé","ǽ":"aé"},"true":{}}};
return function(t){if("function"==typeof getHeaderLen&&getHeaderLen(this.value)>0){var n=this.value.lastIndexOf("(",this.selectionStart-1),a=this.value.lastIndexOf(")",this.selectionStart-1);if(n>a)return}if(187==t.which&&t.shiftKey){var i=this.selectionStart,s=1;return this.value=this.value.slice(0,i)+"†"+this.value.slice(this.selectionEnd),this.selectionStart=this.selectionEnd=i+s,t.preventDefault(),void 0}var r=$("#cbEnglish")[0];if(!r||!r.checked){var l=e[t.which];if(l&&this.selectionStart==this.selectionEnd&&this.selectionStart>0){var o=this.value[this.selectionStart-1],c=l[t.shiftKey][o];if(c){var d=this.selectionEnd,s=c.length-1;return this.value=this.value.slice(0,--this.selectionStart)+c+this.value.slice(d),this.selectionStart=this.selectionEnd=d+s,t.preventDefault(),void 0}}}}}();